# Custom Diffusion

ุชูููุฉ Custom Diffusion ูู ุชูููุฉ ุชุฏุฑูุจ ูุดุฎุตูุฉ ููุงุฐุฌ ุชูููุฏ ุงูุตูุฑ. ูุนูู ุบุฑุงุฑ Textual Inversion ูDreamBooth ูLoRAุ ูุง ุชุชุทูุจ ุชูููุฉ Custom Diffusion ุณูู ุนุฏุฏ ูููู ูู ุงูุตูุฑ (4-5 ุตูุฑ ุชูุฑูุจูุง) ูุฃูุซูุฉ. ุชุนูู ูุฐู ุงูุชูููุฉ ูู ุฎูุงู ุชุฏุฑูุจ ุงูุฃูุฒุงู ูู ุทุจูุงุช ุงูุงูุชูุงู ุงููุชูุงุทุน ููุทุ ูุชุณุชุฎุฏู ูููุฉ ุฎุงุตุฉ ูุชูุซูู ุงูููููู ุงูุฐู ุชู ุชุนููู ุญุฏูุซูุง. ูุชุชููุฒ ุชูููุฉ Custom Diffusion ุจููููุง ูุฑูุฏุฉ ูู ููุนูุง ูุฃููุง ูููู ุฃู ุชุชุนูู ุฃูุถูุง ููุงููู ูุชุนุฏุฏุฉ ูู ููุณ ุงูููุช.

ุฅุฐุง ููุช ุชููู ุจุงูุชุฏุฑูุจ ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุฑุณููุงุช (GPU) ุฐุงุช ุฐุงูุฑุฉ ูุตูู ุนุดูุงุฆู (VRAM) ูุญุฏูุฏุฉุ ููุฌุจ ุนููู ุชุฌุฑุจุฉ ุชูููู xFormers ุจุงุณุชุฎุฏุงู --enable_xformers_memory_efficient_attention ูุชุณุฑูุน ุงูุชุฏุฑูุจ ูุน ุชูููู ูุชุทูุจุงุช ุฐุงูุฑุฉ VRAM (16 ุฌูุฌุงุจุงูุช). ููุชูููุฑ ุงููุฒูุฏ ูู ุงูุฐุงูุฑุฉุ ุฃุถู --set_grads_to_none ูู ุญุฌุฉ ุงูุชุฏุฑูุจ ูุชุนููู ุงูุชุฏุฑุฌุงุช ุฅูู None ุจุฏูุงู ูู ุงูุตูุฑ (ูุฏ ูุณุจุจ ูุฐุง ุงูุฎูุงุฑ ุจุนุถ ุงููุดููุงุชุ ูุฐุง ุฅุฐุง ูุงุฌูุช ุฃู ูุดููุงุชุ ุญุงูู ุฅุฒุงูุฉ ูุฐุง ุงููุนุงูู).

ุณูุชูุงูู ูุฐุง ุงูุฏููู ุจุงูุชูุตูู ุงููุต ุงูุจุฑูุฌู train_custom_diffusion.py ููุณุงุนุฏุชู ุนูู ุงูุชุนุฑู ุนููู ุจุดูู ุฃูุถูุ ูููู ููููู ุชููููู ูุน ุญุงูุชู ุงูุงุณุชุฎุฏุงู ุงูุฎุงุตุฉ.

ูุจู ุชุดุบูู ุงููุต ุงูุจุฑูุฌูุ ุชุฃูุฏ ูู ุชุซุจูุช ุงูููุชุจุฉ ูู ุงููุตุฏุฑ:

```bash
git clone https://github.com/huggingface/diffusers
cd diffusers
pip install .
```

ุงูุชูู ุฅูู ูุฌูุฏ ุงูุฃูุซูุฉ ุงูุฐู ูุญุชูู ุนูู ุงููุต ุงูุจุฑูุฌู ููุชุฏุฑูุจ ููู ุจุชุซุจูุช ุงูุชุจุนูุงุช ุงููุทููุจุฉ:

```bash
cd examples/custom_diffusion
pip install -r requirements.txt
pip install clip-retrieval
```

๐ค Accelerate ูู ููุชุจุฉ ุชุณุงุนุฏู ุนูู ุงูุชุฏุฑูุจ ุนูู ูุญุฏุงุช ูุนุงูุฌุฉ ุฑุณููุงุช (GPUs) ุฃู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฏูุฉ ุงููุงุฆูุฉ (TPUs) ูุชุนุฏุฏุฉ ุฃู ุจุงุณุชุฎุฏุงู ุงูุฏูุฉ ุงููุฎุชูุทุฉ. ูุณุชููู ุชููุงุฆููุง ุจุชููุฆุฉ ุฅุนุฏุงุฏ ุงูุชุฏุฑูุจ ุงูุฎุงุต ุจู ุจูุงุกู ุนูู ุฃุฌูุฒุชู ูุจูุฆุชู. ุงุทูุน ุนูู ุงูุฌููุฉ ุงูุณุฑูุนุฉ ูู ๐ค Accelerate ููุนุฑูุฉ ุงููุฒูุฏ.

ูู ุจุชููุฆุฉ ุจูุฆุฉ ๐ค Accelerate:

```bash
accelerate config
```

ูุฅุนุฏุงุฏ ุจูุฆุฉ ๐ค Accelerate ุงูุงูุชุฑุงุถูุฉ ุฏูู ุงุฎุชูุงุฑ ุฃู ุชููููุงุช:

```bash
accelerate config default
```

ุฃู ุฅุฐุง ูู ูุฏุนู ุจูุฆุชู ุบูุงููุง ุชูุงุนูููุงุ ูุซู ุฏูุชุฑ ููุงุญุธุงุชุ ูููููู ุงุณุชุฎุฏุงู:

```py
from accelerate.utils import write_basic_config

write_basic_config()
```

ุฃุฎูุฑูุงุ ุฅุฐุง ููุช ุชุฑูุฏ ุชุฏุฑูุจ ูููุฐุฌ ุนูู ูุฌููุนุฉ ุจูุงูุงุชู ุงูุฎุงุตุฉุ ูุฑุงุฌุน ุฏููู ุฅูุดุงุก ูุฌููุนุฉ ุจูุงูุงุช ููุชุฏุฑูุจ ููุนุฑูุฉ ููููุฉ ุฅูุดุงุก ูุฌููุนุฉ ุจูุงูุงุช ุชุนูู ูุน ุงููุต ุงูุจุฑูุฌู ููุชุฏุฑูุจ.

ุชุณูุท ุงูุฃูุณุงู ุงูุชุงููุฉ ุงูุถูุก ุนูู ุฃุฌุฒุงุก ูู ุงููุต ุงูุจุฑูุฌู ููุชุฏุฑูุจ ูุงูุชู ุชูุนุฏ ูููุฉ ูููู ููููุฉ ุชุนุฏูููุงุ ูููููุง ูุง ุชุบุทู ูู ุฌุงูุจ ูู ุฌูุงูุจ ุงููุต ุงูุจุฑูุฌู ุจุงูุชูุตูู. ุฅุฐุง ููุช ููุชููุง ุจูุนุฑูุฉ ุงููุฒูุฏุ ูููุฑุฌู ุงูุงุทูุงุน ุนูู ุงููุต ุงูุจุฑูุฌู ูุฅุฎุจุงุฑูุง ุฅุฐุง ูุงู ูุฏูู ุฃู ุฃุณุฆูุฉ ุฃู ูุฎุงูู.

## ูุนููุงุช ุงููุต ุงูุจุฑูุฌู

ูุญุชูู ุงููุต ุงูุจุฑูุฌู ููุชุฏุฑูุจ ุนูู ุฌููุน ุงููุนููุงุช ููุณุงุนุฏุชู ุนูู ุชุฎุตูุต ุนูููุฉ ุชุดุบูู ุงูุชุฏุฑูุจ ุงูุฎุงุตุฉ ุจู. ููููู ุงูุนุซูุฑ ุนูููุง ูู ุฏุงูุฉ parse_args(). ุชุฃุชู ุงูุฏุงูุฉ ูุน ุงูููู ุงูุงูุชุฑุงุถูุฉุ ูููู ููููู ุฃูุถูุง ุชุนููู ูููู ุงูุฎุงุตุฉ ูู ุฃูุฑ ุงูุชุฏุฑูุจ ุฅุฐุง ุฃุฑุฏุช ุฐูู.

ุนูู ุณุจูู ุงููุซุงูุ ูุชุบููุฑ ุฏูุฉ ุตูุฑุฉ ุงูุฅุฏุฎุงู:

```bash
accelerate launch train_custom_diffusion.py \
--resolution=256
```

ุชู ูุตู ุงูุนุฏูุฏ ูู ุงููุนููุงุช ุงูุฃุณุงุณูุฉ ูู ุฏููู ุชุฏุฑูุจ DreamBoothุ ูุฐูู ูุฑูุฒ ูุฐุง ุงูุฏููู ุนูู ุงููุนููุงุช ุงููุฑูุฏุฉ ูุชูููุฉ Custom Diffusion:

- --freeze_model: ูููู ุจุชุฌููุฏ ุงููุนููุงุช ุงูุฃุณุงุณูุฉ ูุงูููู ูู ุทุจูุฉ ุงูุงูุชูุงู ุงููุชูุงุทุนุ ูุงููููุฉ ุงูุงูุชุฑุงุถูุฉ ูู crossattn_kvุ ูููู ููููู ุชุนููููุง ุนูู crossattn ูุชุฏุฑูุจ ุฌููุน ุงููุนููุงุช ูู ุทุจูุฉ ุงูุงูุชูุงู ุงููุชูุงุทุน
- --concepts_list: ูุชุนูู ููุงููู ูุชุนุฏุฏุฉุ ูู ุจุชูููุฑ ูุณุงุฑ ุฅูู ููู JSON ูุญุชูู ุนูู ุงูููุงููู
- --modifier_token: ูููุฉ ุฎุงุตุฉ ุชูุณุชุฎุฏู ูุชูุซูู ุงูููููู ุงูุฐู ุชู ุชุนููู
- --initializer_token: ูููุฉ ุฎุงุตุฉ ุชูุณุชุฎุฏู ูุชููุฆุฉ ุชุถูููุงุช modifier_token

### ุฎุณุงุฑุฉ ุงูุญูุงุธ ุนูู ุงูุฃููููุฉ

ุฎุณุงุฑุฉ ุงูุญูุงุธ ุนูู ุงูุฃููููุฉ ูู ุทุฑููุฉ ุชุณุชุฎุฏู ุนููุงุช ูููุฏุฉ ูู ุงููููุฐุฌ ููุณู ููุณุงุนุฏุชู ุนูู ุชุนูู ููููุฉ ุฅูุดุงุก ุตูุฑ ุฃูุซุฑ ุชููุนูุง. ูุจูุง ุฃู ุตูุฑ ุงูุนููุงุช ุงููููุฏุฉ ูุฐู ุชูุชูู ุฅูู ููุณ ุงููุฆุฉ ุงูุชู ุชูุชูู ุฅูููุง ุงูุตูุฑ ุงูุชู ูุฏูุชูุงุ ูุฅููุง ุชุณุงุนุฏ ุงููููุฐุฌ ุนูู ุงูุงุญุชูุงุธ ุจูุง ุชุนููู ุนู ุงููุฆุฉ ูููู ููููู ุงุณุชุฎุฏุงู ูุง ูุนุฑูู ุจุงููุนู ุนู ุงููุฆุฉ ูุฅูุดุงุก ุชุฑููุจุงุช ุฌุฏูุฏุฉ.

ุชู ูุตู ุงูุนุฏูุฏ ูู ูุนููุงุช ุฎุณุงุฑุฉ ุงูุญูุงุธ ุนูู ุงูุฃููููุฉ ูู ุฏููู ุชุฏุฑูุจ DreamBooth.

### ุงูุถุจุท

ุชุชุถูู ุชูููุฉ Custom Diffusion ุชุฏุฑูุจ ุงูุตูุฑ ุงููุณุชูุฏูุฉ ุจุงุณุชุฎุฏุงู ูุฌููุนุฉ ุตุบูุฑุฉ ูู ุงูุตูุฑ ุงูุญููููุฉ ูููุน ุงูุฅูุฑุงุท ูู ุงูุชูููู. ูููุง ููููู ุฃู ุชุชุฎููุ ูููู ุฃู ูููู ูู ุงูุณูู ุงูููุงู ุจุฐูู ุนูุฏ ุงูุชุฏุฑูุจ ุนูู ุนุฏุฏ ูููู ูู ุงูุตูุฑ ููุท! ูู ุจุชูุฒูู 200 ุตูุฑุฉ ุญููููุฉ ุจุงุณุชุฎุฏุงู clip_retrieval. ูุฌุจ ุฃู ูููู class_prompt ูู ููุณ ูุฆุฉ ุงูุตูุฑ ุงููุณุชูุฏูุฉ. ูุชู ุชุฎุฒูู ูุฐู ุงูุตูุฑ ูู class_data_dir.

```bash
python retrieve.py --class_prompt cat --class_data_dir real_reg/samples_cat --num_class_images 200
```

ูุชูููู ุงูุถุจุทุ ุฃุถู ุงููุนููุงุช ุงูุชุงููุฉ:

- --with_prior_preservation: ูุง ุฅุฐุง ูุงู ุณูุชู ุงุณุชุฎุฏุงู ุฎุณุงุฑุฉ ุงูุญูุงุธ ุนูู ุงูุฃููููุฉ
- --prior_loss_weight: ูุชุญูู ูู ุชุฃุซูุฑ ุฎุณุงุฑุฉ ุงูุญูุงุธ ุนูู ุงูุฃููููุฉ ุนูู ุงููููุฐุฌ
- --real_prior: ูุง ุฅุฐุง ูุงู ุณูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ุตุบูุฑุฉ ูู ุงูุตูุฑ ุงูุญููููุฉ ูููุน ุงูุฅูุฑุงุท ูู ุงูุชูููู

```bash
accelerate launch train_custom_diffusion.py \
--with_prior_preservation \
--prior_loss_weight=1.0 \
--class_data_dir="./real_reg/samples_cat" \
--class_prompt="cat" \
--real_prior=True \
```

## ุงููุต ุงูุจุฑูุฌู ููุชุฏุฑูุจ

ููุฌุฏ ุงููุซูุฑ ูู ุงูุฑููุฒ ูู ูุต Custom Diffusion ุงูุจุฑูุฌู ููุชุฏุฑูุจ ููุงุซูุฉ ูุชูู ุงูููุฌูุฏุฉ ูู ูุต DreamBooth ุงูุจุฑูุฌู ููุชุฏุฑูุจ. ูุฑูุฒ ูุฐุง ุงูุฏููู ุจุฏูุงู ูู ุฐูู ุนูู ุงูุฑููุฒ ุฐุงุช ุงูุตูุฉ ุจุชูููุฉ Custom Diffusion.

ูุญุชูู ูุต Custom Diffusion ุงูุจุฑูุฌู ููุชุฏุฑูุจ ุนูู ูุฆุชูู ูู ูุฌููุนุงุช ุงูุจูุงูุงุช:

- CustomDiffusionDataset: ูุนุงูุฌุฉ ุงูุตูุฑ ุงููุณุจูุฉุ ูุตูุฑ ุงููุฆุฉุ ูุงููุฆุงุช ุงูุชุฏุฑูุจูุฉ
- PromptDataset: ุฅุนุฏุงุฏ ุงููุฆุงุช ูุชูููุฏ ุตูุฑ ุงููุฆุฉ

ุจุนุฏ ุฐููุ ูุชู [ุฅุถุงูุฉ modifier_token ุฅูู ุงููุญูู ุงููุบูู](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/custom_diffusion/train_custom_diffusion.py#L811)ุ ูุชุญููููุง ุฅูู ูุนุฑูุงุช ุงูุฑููุฒุ ูุฅุนุงุฏุฉ ุชุญุฌูู ุชุถูููุงุช ุงูุฑููุฒ ูุญุณุงุจ modifier_token ุงูุฌุฏูุฏ. ุซู ูุชู ุชููุฆุฉ ุชุถูููุงุช modifier_token ุจุงุณุชุฎุฏุงู ุชุถูููุงุช initializer_token. ูุชู ุชุฌููุฏ ุฌููุน ุงููุนููุงุช ูู ุงููุดูุฑ ุงููุตูุ ุจุงุณุชุซูุงุก ุชุถูููุงุช ุงูุฑููุฒ ูุฃู ูุฐุง ูู ูุง ูุญุงูู ุงููููุฐุฌ ุชุนููู ูุฑุจุทู ุจุงูููุงููู.

```py
params_to_freeze = itertools.chain(
text_encoder.text_model.encoder.parameters(),
text_encoder.text_model.final_layer_norm.parameters(),
text_encoder.text_model.embeddings.position_embedding.parameters(),
)
freeze_params(params_to_freeze)
```

ุงูุขูุ ุณุชุญุชุงุฌ ุฅูู ุฅุถุงูุฉ [ุฃูุฒุงู Custom Diffusion](https://github.com/huggingface/diffusers/blob/64603389da01082055a901f2883c4810d1144edb/examples/custom_diffusion/train_custom_diffusion.py#L911C3-L911C3) ุฅูู ุทุจูุงุช ุงูุงูุชูุงู. ูุฐู ุฎุทูุฉ ูููุฉ ููุบุงูุฉ ููุญุตูู ุนูู ุงูุดูู ูุงูุญุฌู ุงูุตุญูุญ ูุฃูุฒุงู ุงูุงูุชูุงูุ ููุชุนููู ุงูุนุฏุฏ ุงูููุงุณุจ ูู ูุนุงูุฌุงุช ุงูุงูุชูุงู ูู ูู ูุชูุฉ UNet.

```py
st = unet.state_dict()
for name, _ in unet.attn_processors.items():
cross_attention_dim = None if name.endswith("attn1.processor") else unet.config.cross_attention_dim
if name.startswith("mid_block"):
hidden_size = unet.config.block_out_channels[-1]
elif name.startswith("up_blocks"):
block_id = int(name[len("up_blocks.")])
hidden_size = list(reversed(unet.config.block_out_channels))[block_id]
elif name.startswith("down_blocks"):
block_id = int(name[len("down_blocks.")])
hidden_size = unet.config.block_out_channels[block_id]
layer_name = name.split(".processor")[0]
weights = {
"to_k_custom_diffusion.weight": st[layer_name + ".to_k.weight"],
"to_v_custom_diffusion.weight": st[layer_name + ".to_v.weight"],
}
if train_q_out:
weights["to_q_custom_diffusion.weight"] = st[layer_name + ".to_q.weight"]
weights["to_out_custom_diffusion.0.weight"] = st[layer_name + ".to_out.0.weight"]
weights["to_out_custom_diffusion.0.bias"] = st[layer_name + ".to_out.0.bias"]
if cross_attention_dim is not None:
custom_diffusion_attn_procs[name] = attention_class(
train_kv=train_kv,
train_q_out=train_q_out,
hidden_size=hidden_size,
cross_attention_dim=cross_attention_dim,
).to(unet.device)
custom_diffusion_attn_procs[name].load_state_dict(weights)
else:
custom_diffusion_attn_procs[name] = attention_class(
train_kv=False,
train_q_out=False,
hidden_size=hidden_size,
cross_attention_dim=cross_attention_dim,
)
del st
unet.set_attn_processor(custom_diffusion_attn_procs)
custom_diffusion_layers = AttnProcsLayers(unet.attn_processors)
```

ูุชู ุชููุฆุฉ [ุงููุญุณู](https://github.com/huggingface/diffusers/blob/84cd9e8d01adb47f046b1ee449fc76a0c32dc4e2/examples/custom_diffusion/train_custom_diffusion.py#L982) ูุชุญุฏูุซ ูุนููุงุช ุทุจูุฉ ุงูุงูุชูุงู ุงููุชูุงุทุน:

```py
optimizer = optimizer_class(
itertools.chain(text_encoder.get_input_embeddings().parameters(), custom_diffusion_layers.parameters())
if args.modifier_token is not None
else custom_diffusion_layers.parameters(),
lr=args.learning_rate,
betas=(args.adam_beta1, args.adam_beta2),
weight_decay=args.adam_weight_decay,
eps=args.adam_epsilon,
)
```

ูู [ุญููุฉ ุงูุชุฏุฑูุจ](https://github.com/huggingface/diffusers/blob/84cd9e8d01adb47f046b1ee449fc76a0c32dc4e2/examples/custom_diffusion/train_custom_diffusion.py#L1048)ุ ูู ุงูููู ุชุญุฏูุซ ุงูุชุถูููุงุช ููููููู ุงูุฐู ุชุญุงูู ุชุนููู ููุท. ููุฐุง ูุนูู ุชุนููู ุงูุชุฏุฑุฌุงุช ูุฌููุน ุงูุชุถูููุงุช ุงูุฑูุฒูุฉ ุงูุฃุฎุฑู ุฅูู ุงูุตูุฑ:

```py
if args.modifier_token is not None:
if accelerator.num_processes > 1:
grads_text_encoder = text_encoder.module.get_input_embeddings().weight.grad
else:
grads_text_encoder = text_encoder.get_input_embeddings().weight.grad
index_grads_to_zero = torch.arange(len(tokenizer)) != modifier_token_id[0]
for i in range(len(modifier_token_id[1:])):
index_grads_to_zero = index_grads_to_zero & (
torch.arange(len(tokenizer)) != modifier_token_id[i]
)
grads_text_encoder.data[index_grads_to_zero, :] = grads_text_encoder.data[
index_grads_to_zero, :
].fill_(0)
```
## ุชุดุบูู ุงูุณูุฑุจุช

ุนูุฏูุง ุชูุชูู ูู ุฅุฌุฑุงุก ุฌููุน ุงูุชุบููุฑุงุช ุฃู ุชููู ุฑุงุถููุง ุนู ุงูุชูููู ุงูุงูุชุฑุงุถูุ ุณุชููู ุฌุงูุฒูุง ูุชุดุบูู ุณูุฑุจุช ุงูุชุฏุฑูุจ! ๐

ูู ูุฐุง ุงูุฏูููุ ุณุชููู ุจุชูุฒูู ูุงุณุชุฎุฏุงู ูุฐู ุงูุตูุฑ ูุซุงู [ุตูุฑ ุงููุทุท](https://www.cs.cmu.edu/~custom-diffusion/assets/data.zip). ููููู ุฃูุถูุง ุฅูุดุงุก ูุงุณุชุฎุฏุงู ูุฌููุนุฉ ุงูุจูุงูุงุช ุงูุฎุงุตุฉ ุจู ุฅุฐุง ููุช ุชุฑูุฏ (ุฑุงุฌุน ุงูุฏููู [ุฅูุดุงุก ูุฌููุนุฉ ุจูุงูุงุช ููุชุฏุฑูุจ](create_dataset)).

ูู ุจุชุนููู ูุชุบูุฑ ุงูุจูุฆุฉ `MODEL_NAME` ุฅูู ูุนุฑู ูููุฐุฌ ุนูู Hub ุฃู ูุณุงุฑ ุฅูู ูููุฐุฌ ูุญููุ ู`INSTANCE_DIR` ุฅูู ุงููุณุงุฑ ุงูุฐู ููุช ุจุชูุฒูู ุตูุฑ ุงููุท ุฅููู ููุชูุ ู`OUTPUT_DIR` ุฅูู ุงูููุงู ุงูุฐู ุชุฑูุฏ ุญูุธ ุงููููุฐุฌ ููู. ุณุชุณุชุฎุฏู `<new1>` ููููุฉ ุฎุงุตุฉ ูุฑุจุท ุงูุชุถูููุงุช ุงูุชู ุชู ุชุนูููุง ุญุฏูุซูุง ุจูุง. ูููู ุงูุณูุฑุจุช ุจุฅูุดุงุก ูุญูุธ ููุงุท ุชูุชูุด ุงููููุฐุฌ ูููู pytorch_custom_diffusion_weights.bin ุฅูู ูุณุชูุฏุนู.

ููุฑุงูุจุฉ ุชูุฏู ุงูุชุฏุฑูุจ ุจุงุณุชุฎุฏุงู Weights and Biasesุ ุฃุถู ุงููุนููุฉ `--report_to=wandb` ุฅูู ุฃูุฑ ุงูุชุฏุฑูุจ ูุญุฏุฏ ููุฌู ุชุญูู ูู ุงูุตุญุฉ ุจุงุณุชุฎุฏุงู `--validation_prompt`. ูุฐุง ูููุฏ ููุชุตุญูุญ ูุญูุธ ุงููุชุงุฆุฌ ุงููุณูุทุฉ.

<Tip>

ุฅุฐุง ููุช ุชุชุฏุฑุจ ุนูู ูุฌูู ุจุดุฑูุฉุ ููุฏ ูุฌุฏ ูุฑูู Custom Diffusion ุฃู ุงููุนููุงุช ุงูุชุงููุฉ ุชุนูู ุจุดูู ุฌูุฏ:

- `--learning_rate=5e-6`
- ูููู ุฃู ูููู `--max_train_steps` ุฃู ุฑูู ุจูู 1000 ู 2000
- `--freeze_model=crossattn`
- ุงุณุชุฎุฏู ูุง ูุง ููู ุนู 15-20 ุตูุฑุฉ ููุชุฏุฑูุจ

</Tip>

<hfoptions id="training-inference">
<hfoption id="single concept">

```bash
export MODEL_NAME="CompVis/stable-diffusion-v1-4"
export OUTPUT_DIR="path-to-save-model"
export INSTANCE_DIR="./data/cat"

accelerate launch train_custom_diffusion.py \
--pretrained_model_name_or_path=$MODEL_NAME \
--instance_data_dir=$INSTANCE_DIR \
--output_dir=$OUTPUT_DIR \
--class_data_dir=./real_reg/samples_cat/ \
--with_prior_preservation \
--real_prior \
--prior_loss_weight=1.0 \
--class_prompt="cat" \
--num_class_images=200 \
--instance_prompt="photo of a <new1> cat" \
--resolution=512 \
--train_batch_size=2 \
--learning_rate=1e-5 \
--lr_warmup_steps=0 \
--max_train_steps=250 \
--scale_lr \
--hflip \
--modifier_token "<new1>" \
--validation_prompt="<new1> cat sitting in a bucket" \
--report_to="wandb" \
--push_to_hub
```

</hfoption>
<hfoption id="multiple concepts">

ูููู ูู Custom Diffusion ุฃูุถูุง ุชุนูู ููุงููู ูุชุนุฏุฏุฉ ุฅุฐุง ูุฏูุช ููู [JSON](https://github.com/adobe-research/custom-diffusion/blob/main/assets/concept_list.json) ูุน ุจุนุถ ุงูุชูุงุตูู ุญูู ูู ููููู ูุฌุจ ุฃู ูุชุนููู.

ูู ุจุชุดุบูู clip-retrieval ูุฌูุน ุจุนุถ ุงูุตูุฑ ุงูุญููููุฉ ูุงุณุชุฎุฏุงููุง ูู ุงูุชูุธูู:

```bash
pip install clip-retrieval
python retrieve.py --class_prompt {} --class_data_dir {} --num_class_images 200
```

ุจุนุฏ ุฐููุ ููููู ุชุดุบูู ุงูุณูุฑุจุช:

```bash
export MODEL_NAME="CompVis/stable-diffusion-v1-4"
export OUTPUT_DIR="path-to-save-model"

accelerate launch train_custom_diffusion.py \
--pretrained_model_Multiplier_path=$MODEL_NAME \
--output_dir=$OUTPUT_DIR \
--concepts_list=./concept_list.json \
--with_prior_preservation \
--real_prior \
--prior_loss_weight=1.0 \
--resolution=512 \
--train_batch_size=2 \
--learning_rate=1e-5 \
--lr_warmup_steps=0 \
--max_train_steps=500 \
--num_class_images=200 \
--scale_lr \
--hflip \
--modifier_token "<new1>+<new2>" \
--push_to_hub
```

</hfoption>
</hfoptions>

ุจูุฌุฑุฏ ุงูุงูุชูุงุก ูู ุงูุชุฏุฑูุจุ ููููู ุงุณุชุฎุฏุงู ูููุฐุฌ Custom Diffusion ุงูุฌุฏูุฏ ููุงุณุชูุชุงุฌ.

<hfoptions id="training-inference">
<hfoption id="single concept">

```py
import torch
from diffusers import DiffusionPipeline

pipeline = DiffusionPipeline.from_pretrained(
"CompVis/stable-diffusion-v1-4", torch_dtype=torch.float16,
).to("cuda")
pipeline.unet.load_attn_procs("path-to-save-model", weight_name="pytorch_custom_diffusion_weights.bin")
pipeline.load_textual_inversion("path-to-save-model", weight_name="<new1>.bin")

image = pipeline(
"<new1> cat sitting in a bucket",
num_inference_steps=100,
guidance_scale=6.0,
eta=1.0,
).images[0]
image.save("cat.png")
```

</hfoption>
<hfoption id="multiple concepts">

```py
import torch
from huggingface_hub.repocard import RepoCard
from diffusers import DiffusionPipeline

pipeline = DiffusionPipeline.from_pretrained("sayakpaul/custom-diffusion-cat-wooden-pot", torch_dtype=torch.float16).to("cuda")
pipeline.unet.load_attn_procs(model_id, weight_name="pytorch_custom_diffusion_weights.bin")
pipeline.load_textual_inversion(model_id, weight_name="<new1>.bin")
pipeline.load_textual_inversion(model_id, weight_name="<new2>.bin")

image = pipeline(
"the <new1> cat sculpture in the style of a <new2> wooden pot",
num_inference_steps=100,
guidance_scale=6.0,
eta=1.0,
).images[0]
image.save("multi-subject.png")
```

</hfoption>
</hfoptions>

## ุงูุฎุทูุงุช ุงูุชุงููุฉ

ุชูุงูููุง ุนูู ุชุฏุฑูุจ ูููุฐุฌ ุจุงุณุชุฎุฏุงู Custom Diffusion! ๐ ููุฒูุฏ ูู ุงููุนูููุงุช:

- ุงูุฑุฃ ููุดูุฑ ุงููุฏููุฉ [ุชุฎุตูุต ุงูููููู ุงููุชุนุฏุฏ ููุดุฑ ุงููุต ุฅูู ุงูุตูุฑุฉ](https://www.cs.cmu.edu/~custom-diffusion/) ููุนุฑูุฉ ุงููุฒูุฏ ูู ุงูุชูุงุตูู ุญูู ุงููุชุงุฆุฌ ุงูุชุฌุฑูุจูุฉ ูู ูุฑูู Custom Diffusion.