# ุชูููู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ 

ุชุดูู ุงููููุฉ ุงููุจูุฑุฉ ูู ุงูุฐุงูุฑุฉ ุงููุทููุจุฉ ุนุงุฆููุง ุฃูุงู ุงุณุชุฎุฏุงู ููุงุฐุฌ ุงูุงูุชุดุงุฑ. ูููุชุบูุจ ุนูู ูุฐุง ุงูุชุญุฏูุ ููุงู ุงูุนุฏูุฏ ูู ุงูุชูููุงุช ูุชูููู ุงูุฐุงูุฑุฉ ุงูุชู ููููู ุงุณุชุฎุฏุงููุง ูุชุดุบูู ุญุชู ุฃูุจุฑ ุงูููุงุฐุฌ ุนูู ูุญุฏุงุช ูุนุงูุฌุฉ ุงูุฑุณูููุงุช (GPU) ูู ุงููุฆุฉ ุงููุฌุงููุฉ ุฃู ุงููุฎุตุตุฉ ูููุณุชููููู. ููููู ุญุชู ุงูุฌูุน ุจูู ุจุนุถ ูุฐู ุงูุชูููุงุช ูุฒูุงุฏุฉ ุชูููู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ. 

ูู ูุซูุฑ ูู ุงูุญุงูุงุชุ ูุคุฏู ุงูุชุญุณูู ูู ุฃุฌู ุงูุฐุงูุฑุฉ ุฃู ุงูุณุฑุนุฉ ุฅูู ุชุญุณูู ุงูุฃุฏุงุก ูู ุงูุฌุงูุจ ุงูุขุฎุฑุ ูุฐูู ูุฌุจ ุนููู ูุญุงููุฉ ุงูุชุญุณูู ููููููุง ูููุง ุงุณุชุทุนุช. ููุฑูุฒ ูุฐุง ุงูุฏููู ุนูู ุชูููู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ ุฅูู ุงูุญุฏ ุงูุฃุฏููุ ูููู ููููู ุฃูุถูุง ูุนุฑูุฉ ุงููุฒูุฏ ุญูู ููููุฉ ุชุณุฑูุน ุงูุงุณุชูุชุงุฌ. 

ุชู ุงูุญุตูู ุนูู ุงููุชุงุฆุฌ ุฃุฏูุงู ูู ุฎูุงู ุฅูุดุงุก ุตูุฑุฉ ูุงุญุฏุฉ ุจุญุฌู 512x512 ูู ููุฌู "ุตูุฑุฉ ูุฑุงุฆุฏ ูุถุงุก ูุฑูุจ ุญุตุงููุง ุนูู ุงููุฑูุฎ" ูุน 50 ุฎุทูุฉ ูู DDIM ุนูู Nvidia Titan RTXุ ููุง ููุถุญ ุงูุชุณุฑูุน ุงูุฐู ูููู ุชููุนู ูุชูุฌุฉ ูุงูุฎูุงุถ ุงุณุชููุงู ุงูุฐุงูุฑุฉ. 

|                  | ุงููููู | ุงูุชุณุฑูุน |
| ---------------- | ------- | ------- |
| ุงูุฃุตูู         | 9.50 ุซุงููุฉ   | 1x      |
| FP16             | 3.61 ุซุงููุฉ   | 2.63x   |
| ุงููููุงุช ุงูุฃุฎูุฑุฉ    | 3.30 ุซุงููุฉ   | 2.88x   |
| ุชุชุจุน UNet      | 3.21 ุซุงููุฉ   | 2.96x   |
| ุงูุชุจุงู ูุนุงู ุงูุฐุงูุฑุฉ | 2.63 ุซุงููุฉ  | 3.61x   |

## VAE ุงูููุทูุน

ุชูููู VAE ุงูููุทูุนุฉ ูู ูู ุชุดููุฑ ุฏูุนุงุช ูุจูุฑุฉ ูู ุงูุตูุฑ ุฐุงุช ุฐุงูุฑุฉ VRAM ูุญุฏูุฏุฉ ุฃู ุฏูุนุงุช ุชุญุชูู ุนูู 32 ุตูุฑุฉ ุฃู ุฃูุซุฑ ุนู ุทุฑูู ูู ุชุดููุฑ ุฏูุนุงุช ุงููุฎูููุงุช ุตูุฑุฉ ูุงุญุฏุฉ ูู ูู ูุฑุฉ. ูู ุงููุญุชูู ุฃู ุชุฑุบุจ ูู ุงูุชุฑุงู ูุฐุง ูุน [`~ModelMixin.enable_xformers_memory_efficient_attention`] ูุชูููู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ ุจุดูู ุฃูุจุฑ ุฅุฐุง ูุงู ูุฏูู xFormers ูุซุจุชูุง. 

ูุงุณุชุฎุฏุงู VAE ุงูููุทูุนุฉุ ุงุชุตู ุจู [`~StableDiffusionPipeline.enable_vae_slicing`] ุนูู ุฎุท ุงูุฃูุงุจูุจ ุงูุฎุงุต ุจู ูุจู ุงูุงุณุชุฏูุงู: 

```python
import torch
from diffusers import StableDiffusionPipeline

pipe = StableDiffusionPipeline.from_pretrained(
"runwayml/stable-diffusion-v1-5",
torch_dtype=torch.float16,
use_safetensors=True,
)
pipe = pipe.to("cuda")

prompt = "a photo of an astronaut riding a horse on mars"
pipe.enable_vae_slicing()
#pipe.enable_xformers_memory_efficient_attention()
images = pipe([prompt] * 32).images
``` 

ูุฏ ุชุดุงูุฏ ุฒูุงุฏุฉ ุทูููุฉ ูู ุงูุฃุฏุงุก ูู ูู ุชุดููุฑ VAE ุนูู ุฏูุนุงุช ูุชุนุฏุฏุฉ ุงูุตูุฑุ ููุง ููุจุบู ุฃู ูููู ููุงู ุฃู ุชุฃุซูุฑ ุนูู ุงูุฃุฏุงุก ูู ุฏูุนุงุช ุงูุตูุฑ ุงููุฑุฏูุฉ. 

## ูุนุงูุฌุฉ VAE ุงููุจูุทุฉ

ุชูููู ูุนุงูุฌุฉ VAE ุงููุจูุทุฉ ุฃูุถูุง ูู ุงูุนูู ูุน ุตูุฑ ูุจูุฑุฉ ุฐุงุช ุฐุงูุฑุฉ VRAM ูุญุฏูุฏุฉ (ุนูู ุณุจูู ุงููุซุงูุ ุฅูุดุงุก ุตูุฑ 4K ุนูู 8 ุฌูุฌุงุจุงูุช ูู ุฐุงูุฑุฉ VRAM) ุนู ุทุฑูู ุชูุณูู ุงูุตูุฑุฉ ุฅูู ุจูุงุทุงุช ูุชุฏุงุฎูุฉุ ููู ุชุดููุฑ ุงูุจูุงุทุงุชุ ุซู ูุฒุฌ ุงููุฎุฑุฌุงุช ูุนูุง ูุชูููู ุงูุตูุฑุฉ ุงูููุงุฆูุฉ. ูุฌุจ ุฃูุถูุง ุงุณุชุฎุฏุงู VAE ุงููุจูุทุฉ ูุน [`~ModelMixin.enable_xformers_memory_efficient_attention`] ูุชูููู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ ุจุดูู ุฃูุจุฑ ุฅุฐุง ูุงู ูุฏูู xFormers ูุซุจุชูุง. 

ูุงุณุชุฎุฏุงู ูุนุงูุฌุฉ VAE ุงููุจูุทุฉุ ุงุชุตู ุจู [`~StableDiffusionPipeline.enable_vae_tiling`] ุนูู ุฎุท ุงูุฃูุงุจูุจ ุงูุฎุงุต ุจู ูุจู ุงูุงุณุชุฏูุงู: 

```python
import torch
from diffusers import StableDiffusionPipeline, UniPCMultistepScheduler

pipe = StableDiffusionPipeline.from_pretrained(
"runwayml/stable-diffusion-v1-5",
torch_dtype=torch.float16,
use_safetensors=True,
)
pipe.scheduler = UniPCMultistepScheduler.from_config(pipe.scheduler.config)
pipe = pipe.to("cuda")
prompt = "a beautiful landscape photograph"
pipe.enable_vae_tiling()
#pipe.enable_xformers_memory_efficient_attention()

image = pipe([prompt], width=3840, height=2224, num_inference_steps=20).images[0]
``` 

ุชูุฌุฏ ุจุนุถ ุงูุงุฎุชูุงูุงุช ูู ุงูุชุฏุฑุฌ ุจูู ุงูุจูุงุท ูุงูุจูุงุท ูู ุงูุตูุฑุฉ ุงููุงุชุฌุฉ ูุฃู ุงูุจูุงุทุงุช ูุชู ูู ุชุดููุฑูุง ุจุดูู ูููุตูุ ูููู ูุง ูุฌุจ ุฃู ุชุฑู ุฃู ุฏุฑุฒุงุช ุญุงุฏุฉ ููุงุถุญุฉ ุจูู ุงูุจูุงุทุงุช. ูุชู ุฅููุงู ุงูุชุจููุท ููุตูุฑ ุงูุชู ูุจูุบ ุญุฌููุง 512x512 ุฃู ุฃุตุบุฑ. 

## ุชูุฑูุบ ุงูุฐุงูุฑุฉ ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ

ูููู ุฃูุถูุง ุชูููุฑ ุงูุฐุงูุฑุฉ ุนู ุทุฑูู ุชูุฑูุบ ุงูุฃูุฒุงู ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ (CPU) ูุชุญููููุง ููุท ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุนูุฏ ุฅุฌุฑุงุก ุชูุฑูุฑ ููุฃูุงู. ูุบุงูุจูุง ูุง ูููู ุฃู ุชููู ูุฐู ุงูุชูููุฉ ูู ุงุณุชููุงู ุงูุฐุงูุฑุฉ ุฅูู ุฃูู ูู 3 ุฌูุฌุงุจุงูุช. 

ูุฃุฏุงุก ุงูุชูุฑูุบ ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉุ ุงุชุตู ุจู [`~StableDiffusionPipeline.enable_sequential_cpu_offload`]: 

```Python
import torch
from diffusers import StableDiffusionPipeline

pipe = StableDiffusionPipeline.from_pretrained(
"runwayml/stable-diffusion-v1-5",
torch_dtype=torch.float16,
use_safetensors=True,
)

prompt = "a photo of an astronaut riding a horse on mars"
pipe.enable_sequential_cpu_offload()
image = pipe(prompt).images[0]
``` 

ูุนูู ุชูุฑูุบ ุงูุฐุงูุฑุฉ ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุนูู ุงููุญุฏุงุช ุงููุฑุนูุฉ ุจุฏูุงู ูู ุงูููุงุฐุฌ ุงููุงููุฉ. ูุฐู ูู ุงูุทุฑููุฉ ุงููุซูู ูุชูููู ุงุณุชููุงู ุงูุฐุงูุฑุฉุ ูููู ุงูุงุณุชุฏูุงู ุฃุจุทุฃ ุจูุซูุฑ ุจุณุจุจ ุงูุทุจูุนุฉ ุงููุชูุฑุฑุฉ ูุนูููุฉ ุงูุงูุชุดุงุฑ. ุชููู ููููุงุช UNet ูู ุฎุท ุงูุฃูุงุจูุจ ุจุชุดุบูู ุนุฏุฉ ูุฑุงุช (ูุซู ุนุฏุฏ `num_inference_steps`)ุ ูู ูู ูุฑุฉุ ูุชู ุชุญููู ุงููุญุฏุงุช ุงููุฑุนูุฉ ูู UNet ูุชุญููููุง ุจุดูู ูุชุณูุณู ุญุณุจ ุงูุญุงุฌุฉุ ููุง ูุคุฏู ุฅูู ุนุฏุฏ ูุจูุฑ ูู ุนูููุงุช ููู ุงูุฐุงูุฑุฉ. 

ุถุน ูู ุงุนุชุจุงุฑู ุงุณุชุฎุฏุงู [ุชูุฑูุบ ุงูุฐุงูุฑุฉ ุฅูู ุงููููุฐุฌ](#model-offloading) ุฅุฐุง ููุช ุชุฑูุฏ ุงูุชุญุณูู ูู ุฃุฌู ุงูุณุฑุนุฉ ูุฃูู ุฃุณุฑุน ุจูุซูุฑ. ุงูููุงูุถุฉ ูู ุฃู ูููุฑุงุช ุงูุฐุงูุฑุฉ ุงูุฎุงุตุฉ ุจู ูู ุชููู ูุจูุฑุฉ. 

<Tip> 

ุนูุฏ ุงุณุชุฎุฏุงู [`~StableDiffusionPipeline.enable_sequential_cpu_offload`]ุ ูุง ุชููู ุฎุท ุงูุฃูุงุจูุจ ุฅูู CUDA ูุณุจููุง ูุฅูุง ุณุชููู ุงูุฒูุงุฏุฉ ูู ุงุณุชููุงู ุงูุฐุงูุฑุฉ ุทูููุฉ ููุท (ุฑุงุฌุน ูุฐุง [ุงููุถูุฉ](https://github.com/huggingface/diffusers/issues/1934) ููุฒูุฏ ูู ุงููุนูููุงุช). 

[`~StableDiffusionPipeline.enable_sequential_cpu_offload`] ูู ุนูููุฉ ุฐุงุช ุญุงูุฉ ุชููู ุจุชุซุจูุช ุงูุฎุทุงูุงุช ุนูู ุงูููุงุฐุฌ. 

</Tip> 

## ุชูุฑูุบ ุงูุฐุงูุฑุฉ ุฅูู ุงููููุฐุฌ

<Tip> 

ูุชุทูุจ ุชูุฑูุบ ุงูุฐุงูุฑุฉ ุฅูู ุงููููุฐุฌ ๐ค Accelerate ุงูุฅุตุฏุงุฑ 0.17.0 ุฃู ุฃุนูู. 

</Tip> 

ูุญุงูุธ [ุชูุฑูุบ ุงูุฐุงูุฑุฉ ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ ุจุดูู ูุชุณูุณู](#cpu-offloading) ุนูู ุงููุซูุฑ ูู ุงูุฐุงูุฑุฉ ููููู ูุฌุนู ุงูุงุณุชุฏูุงู ุฃุจุทุฃ ูุฃู ุงููุญุฏุงุช ุงููุฑุนูุฉ ูุชู ููููุง ุฅูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุญุณุจ ุงูุญุงุฌุฉุ ููุชู ุฅุฑุฌุงุนูุง ุนูู ุงูููุฑ ุฅูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ (CPU) ุนูุฏูุง ูุชู ุชุดุบูู ูุญุฏุฉ ุฌุฏูุฏุฉ. 

ูุงูุชูุฑูุบ ุฅูู ุงููููุฐุฌ ุจุงููุงูู ูู ุจุฏูู ูููู ุงูููุงุฐุฌ ุงููุงููุฉ ุฅูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU)ุ ุจุฏูุงู ูู ุงูุชุนุงูู ูุน ุงููุญุฏุงุช ุงููุฑุนูุฉ ููู ูููุฐุฌ. ููุงู ุชุฃุซูุฑ ุถุฆูู ุนูู ููุช ุงูุงุณุชุฏูุงู (ููุงุฑูุฉ ุจููู ุฎุท ุงูุฃูุงุจูุจ ุฅูู `cuda`)ุ ููุง ูุฒุงู ูููุฑ ุจุนุถ ูููุฑุงุช ุงูุฐุงูุฑุฉ. 

ุฃุซูุงุก ุชูุฑูุบ ุงูุฐุงูุฑุฉ ุฅูู ุงููููุฐุฌุ ูุชู ูุถุน ุฃุญุฏ ุงูููููุงุช ุงูุฑุฆูุณูุฉ ูุฎุท ุงูุฃูุงุจูุจ ููุท (ุนุงุฏุฉู ูุง ูููู ูุดูุฑ ุงููุตุ ู UNet ู VAE) ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุจูููุง ุชูุชุธุฑ ุงูููููุงุช ุงูุฃุฎุฑู ูู ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ (CPU). ุชุธู ุงูููููุงุช ูุซู UNet ุงูุชู ุชุนูู ูุนุฏุฉ ุชูุฑุงุฑุงุช ุนูู ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU) ุญุชู ุชุตุจุญ ุบูุฑ ูุทููุจุฉ. 

ูู ุจุชูููู ุชูุฑูุบ ุงูุฐุงูุฑุฉ ุฅูู ุงููููุฐุฌ ุนู ุทุฑูู ุงูุงุชุตุงู ุจู [`~StableDiffusionPipeline.enable_model_cpu_offload`] ุนูู ุฎุท ุงูุฃูุงุจูุจ: 

```Python
import torch
from diffusers import StableDiffusionPipeline

pipe = StableDiffusionPipeline.from_pretrained(
"runwayml/stable-diffusion-v1-5",
torch_dtype=torch.float16,
use_safetensors=True,
)

prompt = "a photo of an astronaut riding a horse on mars"
pipe.enable_model_cpu_offload()
image = pipe(prompt).images[0]
``` 

<Tip> 

ูุฅูุบุงุก ุชุญููู ุงูููุงุฐุฌ ุจุดูู ุตุญูุญ ุจุนุฏ ุงุณุชุฏุนุงุฆูุงุ ูู ุงูุถุฑูุฑู ุชุดุบูู ุฎุท ุงูุฃูุงุจูุจ ุจุงููุงูู ููุฌุจ ุงุณุชุฏุนุงุก ุงูููุงุฐุฌ ูู ุงูุชุฑุชูุจ ุงููุชููุน ูุฎุท ุงูุฃูุงุจูุจ. ุชูุฎ ุงูุญุฐุฑ ุฅุฐุง ุชูุช ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุงูููุงุฐุฌ ุฎุงุฑุฌ ุณูุงู ุฎุท ุงูุฃูุงุจูุจ ุจุนุฏ ุชุซุจูุช ุงูุฎุทุงูุงุช. ุฑุงุฌุน [ุฅุฒุงูุฉ ุงูุฎุทุงูุงุช](https://huggingface.co/docs/accelerate/en/package_reference/big_modeling#accelerate.hooks.remove_hook_from_module) ููุฒูุฏ ูู ุงููุนูููุงุช. 

[`~StableDiffusionPipeline.enable_model_cpu_offload`] ูู ุนูููุฉ ุฐุงุช ุญุงูุฉ ุชููู ุจุชุซุจูุช ุงูุฎุทุงูุงุช ุนูู ุงูููุงุฐุฌ ูุงูุญุงูุฉ ุนูู ุฎุท ุงูุฃูุงุจูุจ. 

</Tip> 

## ุชูุณูู ุงูุฐุงูุฑุฉ ูููููุงุช ุงูุฃุฎูุฑุฉ

ุชูุณูู ุงูุฐุงูุฑุฉ ูููููุงุช ุงูุฃุฎูุฑุฉ ูู ุทุฑููุฉ ุจุฏููุฉ ูุชุฑุชูุจ ูุณูุฌ NCHW ูู ุงูุฐุงูุฑุฉ ููุญูุงุธ ุนูู ุชุฑุชูุจ ุงูุฃุจุนุงุฏ. ูุชู ุชุฑุชูุจ ูุณูุฌ ุงููููุงุช ุงูุฃุฎูุฑุฉ ุจุทุฑููุฉ ุชุฌุนู ุงููููุงุช ูู ุงูุจุนุฏ ุงูุฃูุซุฑ ูุซุงูุฉ (ุชุฎุฒูู ุงูุตูุฑ ุจูุณู ููู ุจูุณู). ูุธุฑูุง ูุฃู ุงููุดุบููู ูุง ูุฏุนููู ุฌููุน ุชูุณูู ุงููููุงุช ุงูุฃุฎูุฑ ุญุงูููุงุ ููุฏ ูุคุฏู ุฐูู ุฅูู ุฃุฏุงุก ุฃุณูุฃุ ูููู ูุฌุจ ุนููู ูุน ุฐูู ุงููุญุงููุฉ ููุนุฑูุฉ ูุง ุฅุฐุง ูุงู ูุนูู ููููุฐุฌู. 

ุนูู ุณุจูู ุงููุซุงูุ ูุชุนููู UNet ูู ุฎุท ุงูุฃูุงุจูุจ ูุงุณุชุฎุฏุงู ุชูุณูู ุงููููุงุช ุงูุฃุฎูุฑ: 

```python
print(pipe.unet.conv_out.state_dict()["weight"].stride())  # (2880, 9, 3, 1)
pipe.unet.to(memory_format=torch.channels_last)  # ุนูููุฉ ูู ุงูููุงู
print(
pipe.unet.conv_out.state_dict()["weight"].stride()
)  # (2880, 1, 960ุ 320) ูุฌูุฏ ุฎุทูุฉ 1 ููุจุนุฏ 2 ูุซุจุช ุฃูู ูุนูู
```

## ุงูุชุชุจุน 

ูููู ุงูุชุชุจุน ุจุชุดุบูู ูุณูุฌ ุฅุฏุฎุงู ูุซุงู ุนุจุฑ ุงููููุฐุฌ ููุญุชูุธ ุจุงูุนูููุงุช ุงูุชู ูุชู ุฅุฌุฑุงุคูุง ุนููู ุฃุซูุงุก ุงูุชูุงู ุงูุฅุฏุฎุงู ุนุจุฑ ุทุจูุงุช ุงููููุฐุฌ. ูุชู ุชุญุณูู ุงูุฏุงูุฉ ุงููุงุจูุฉ ููุชูููุฐ ุฃู `ScriptFunction` ุงูุชู ูุชู ุฅุฑุฌุงุนูุง ุจุงุณุชุฎุฏุงู ุงูุชุฌููุน ุงููุณุจู ูู ุงูููุช ุงูููุงุณุจ. 

ูุชุชุจุน UNet: 

```python
import time
import torch
from diffusers import StableDiffusionPipeline
import functools

# ุฅููุงู ุชุดุบูู ุชุฏุฑุฌ ุงูุดุนูุฉ
torch.set_grad_enabled(False)

# ุชุนููู ุงููุชุบูุฑุงุช
n_experiments = 2
unet_runs_per_experiment = 50


# ุชุญููู ุงููุฏุฎูุงุช
def generate_inputs():
sample = torch.randn((2, 4, 64, 64), device="cuda"ุ dtype=torch.float16)
timestep = torch.rand(1, device="cuda"ุ dtype=torch.float16) * 999
encoder_hidden_states = torch.randn((2, 77, 768), device="cuda"ุ dtype=torch.float16)
return sample, timestep, encoder_hidden_states


pipe = StableDiffusionPipeline.from_pretrained(
"runwayml/stable-diffusion-v1-5"ุ
torch_dtype=torch.float16,
use_safetensors=True,
).to("cuda")
unet = pipe.unet
unet.eval()
unet.to(memory_format=torch.channels_last)  # ุงุณุชุฎุฏุงู ุชูุณูู ุงูุฐุงูุฑุฉ ูููููุงุช ุงูุฃุฎูุฑุฉ
unet.forward = functools.partial(unet.forward, return_dict=False)  # ุชุนููู return_dict=False ูุงูุชุฑุงุถู

# ุงูุฅุญูุงุก
for _ in range(3):
with torch.inference_mode():
inputs = generate_inputs()
orig_output = unet(*inputs)

# ุงูุชุชุจุน
print("ุงูุชุชุจุน..")
unet_traced = torch.jit.trace(unet, inputs)
unet_traced.eval()
print("ุงูุชูู ุงูุชุชุจุน")


# ุงูุฅุญูุงุก ูุชุญุณูู ุงูุฑุณู ุงูุจูุงูู
for _ in range(5):
with torch.inference_mode():
inputs = generate_inputs()
orig_output = unet_traced(*inputs)


# ุงููุนุงูุฑุฉ
with torch.inference_mode():
for _ in range(n_experiments):
torch.cuda.synchronize()
start_time = time.time()
for _ in range(unet_runs_per_experiment):
orig_output = unet_traced(*inputs)
torch.cuda.synchronize()
print(f"ุงุณุชุบุฑู ุงูุงุณุชุฏูุงู ุงูููุทูุน ูู UNet {time.time() - start_time:.2f} ุซุงููุฉ")
for _ in range(n_experiments):
torch.cuda.synchronize()
start_time = time.time()
for _ in range(unet_runs_per_experiment):
orig_output = unet(*inputs)
torch.cuda.synchronize()
print(f"ุงุณุชุบุฑู ุงูุงุณุชุฏูุงู ูู UNet {time.time() - start_time:.2f} ุซุงููุฉ")

# ุญูุธ ุงููููุฐุฌ
unet_traced.save("unet_traced.pt")
``` 

ุงุณุชุจุฏู ุณูุฉ `unet` ูุฎุท ุงูุฃูุงุจูุจ ุจุงููููุฐุฌ ุงูููุทูุน: 

```python
from diffusers import StableDiffusionPipeline
import torch
from dataclasses import dataclass


@dataclass
class UNet2DConditionOutput:
sample: torch.Tensor


pipe = StableDiffusionPipeline.from_pretrained(
"runwayml/stable-diffusion-v1-5"ุ
torch_dtype=torch.float16,
use_safetensors=True,
).to("cuda")

# ุงุณุชุฎุฏุงู UNet ุงูููุทูุน
unet_traced = torch.jit.load("unet_traced.pt")


# ุญุฐู pipe.unet
class TracedUNet(torch.nn.Module):
def __init__(self):
super().__init__()
self.in_channels = pipe.unet.config.in_channels
self.device = pipe.unet.device

def forward(selfุ latent_model_inputุ tุ encoder_hidden_states):
sample = unet_traced(latent_model_inputุ tุ encoder_hidden_states)[0]
return UNet2DConditionOutput(sample=sample)


pipe.unet = TracedUNet()

with torch.inference_mode():
image = pipe([prompt] * 1, num_inference_steps=50).images[0]
```

## ุงูุชุจุงู ูุนุงู ุงูุฐุงูุฑุฉ 

ุฃุฏู ุงูุนูู ุงูุฃุฎูุฑ ุญูู ุชุญุณูู ุนุฑุถ ุงููุทุงู ุงูุชุฑุฏุฏู ูู ูุชูุฉ ุงูุงูุชูุงู ุฅูู ุชุณุฑูุน ูุจูุฑ ูุชุฎููุถุงุช ูู ุงุณุชุฎุฏุงู ุฐุงูุฑุฉ ูุญุฏุฉ ูุนุงูุฌุฉ ุงูุฑุณููุงุช (GPU). ูุขุฎุฑ ููุน ูู ุงูุชุจุงู ูุนุงู ุงูุฐุงูุฑุฉ ูู [Flash Attention](https://arxiv.org/abs/2205.14135) (ููููู ุงูุงุทูุงุน ุนูู ุงูููุฏ ุงูุฃุตูู ูู [HazyResearch/flash-attention](https://github.com/HazyResearch/flash-attention)). 

<Tip> 

ุฅุฐุง ูุงู ูุฏูู PyTorch >= 2.0 ูุซุจุชูุงุ ููุง ููุจุบู ุฃู ุชุชููุน ุชุณุฑูุน ุงูุงุณุชุฏูุงู ุนูุฏ ุชูููู `xformers`. 

</Tip> 

ูุงุณุชุฎุฏุงู Flash Attentionุ ูู ุจุชุซุจูุช ูุง ููู: 

- Python > 1.12
- CUDA ูุชุงุญ
- [xFormers](xformers) 

ุซู ุงุชุตู ุจู [`~ModelMixin.enable_xformers_memory_efficient_attention`] ุนูู ุฎุท ุงูุฃูุงุจูุจ: